#!/bin/bash
# {{ansible_managed}}

set -e
set -o pipefail

TARGET_FILE="/etc/icinga/objects/contacts.cfg"

define_contact() {
    local ID="$1"
    local DISPLAY_NAME="$2"
    local MAIL="$3"

    cat <<EOF

define contact{
  contact_name  $ID
  use           generic_contact
  alias         $DISPLAY_NAME
  email         $MAIL
}

EOF
}

reset_vars() {
    ID=
    MAIL=
    DISPLAY_NAME=
}

reset_vars

TMP_FILE="$(mktemp --tmpdir icinga_update_contacts.sh.XXXXXXXX)"

init_tmp_file() {
    echo "# Do not edit. This file got automatically generated by $0" >"$TMP_FILE"

    chmod 444 "$TMP_FILE"
}

init_tmp_file

while read LINE
do
    case "${LINE%%:*}" in
        "uid" )
            ID="${LINE#*: }"
            ;;
        "displayName" )
            DISPLAY_NAME="${LINE#*: }"
            ;;
        "mail" )
            MAIL="${LINE#*: }"
            ;;
        "" )
            if [ -n "$ID" -a -n "$DISPLAY_NAME" -a -n "$MAIL" ]
            then
                define_contact "$ID" "$DISPLAY_NAME" "$MAIL"
            fi
            reset_vars
            ;;
    esac
done >>"$TMP_FILE" < <( ldapsearch -D '' -LLL -ZZ -b 'ou={{ldap_server_ou_people}},{{ldap_server_base_dn}}' uid mail displayName )

if ! diff -q "$TMP_FILE" "$TARGET_FILE" &>/dev/null
then
    mv "$TMP_FILE" "$TARGET_FILE"
    echo "Updated '$TARGET_FILE'"
fi
